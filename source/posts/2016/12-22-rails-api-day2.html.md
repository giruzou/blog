---
title: Ruby on RailsでつくってみるAPI（2日目）
date: 2016-12-22 10:10 JST
tags: やぎすけAdventCalendar2016,Rails
---

こんにちは、やぎにいです。
[やぎすけ Advent Calendar 2016](http://www.adventar.org/calendars/1800)の22日目です。  
今日が終わればもう25日まで祝休日ですね。頑張っていきましょう。  

昨日は僕が[Ruby on RailsでつくるAPI（導入編）](https://blog.yagi2.com/2016/12/21/rails-api-day1.html)を書きました。  
  
今日は無事jsonデータを返すところまで作れたものに機能を追加します。  
<br><br>
## 機能の追加
昨日はデータベースに流したアイマスのキャラ情報をすべて返すAPIを作ることが出来ました。  
正直言えば、あとは使う側が要らないキャラ情報を使わなくすればいいのでこれで完成！と言っても良いのですが、データ通信量等々を考えると現実的ではありません。アイマスのキャラは300人位いますし、楽曲に至っては600曲くらいありますし今も増えてます（昨日も増えましたね）。  
それに対して要素があるとしたらすべてを返すAPIを使おうとすると膨大なデータ量のやりとりになります。  
使う側が欲しい分だけをリクエストして、それを返す形が理想です。  
  
というわけで、今回は昨日作ったAPIに「絞り込む」機能を追加したいと思います。  
  
完成形としては  

* URIのクエリで名前をつけるとそれに合致した物を返す（複数合致したら複数返す）
* でも全件ほしいときは全件返して欲しい

これを目指していきます。  
<br><br>
## ルーティングを設定する
今回は「絞り込み」の機能を実装するわけですが、同時に全件返す昨日作った部分も残しておく形になります。  
同時に2つの機能を両立させるためにURIを考えましょう。  
僕がGitHubに立てたIssueはこれです。  

![](2016/12-22-rails-api-day2-001.png)  
  
いや、これは良くない設計だろうと思われるかもしれませんが、ペーペーなので許してください。  
僕は以下のように作ろう！と決意しました。  
  
* `characters/`  
昨日まではこれを叩くと全件返ってきていたが、これを叩くと`characters/`から始まるAPIの使い方、リクエストとレスポンスの仕様などがHTMLで表示されるページを出す  
* `characters/search`  
このsearchで絞り込みをできるようにする、例えば名前で絞り込むなら`characters/search?name="なまえ"`とか
* `characters/all`  
これを叩くと昨日までと同様の全件返ってくる。クエリは無し、否応なしに全件返す  

このような形にしたいと思います。  
ではルーティングを設定してあげましょう。  
それぞれGETで叩き、それらはすべて`characters_controller`に飛ばします。
  
`config/routes.rb`がルーティングの設定を記述する場所です。  
  
```rb
Rails.application.routes.draw do
  get '/characters',        to: 'characters#index'
  get '/characters/search', to: 'characters#search'
  get '/characters/all',    to: 'characters#all'
end
```

* `/characters`にGETリクエストが来たら`characters_controller`の`index`に飛ばす  
* `/characters/search`にGETリクエストが来たら`characters_controller`の`search`に飛ばす  
* `/characters/all`にGETリクエストが来たら`characters_controller`の`all`に飛ばす

そんな感じです。  
これでルーティングは完成です。  
<br><br>
## コントローラーをつくる
先ほどルーティングで`characters_controller`に飛ばす部分は作りました。では次はそのコントローラーで受け取り、処理して返却する機能部分を作りましょう。  
  
まずは`/characters`にアクセスが来た時。  
これはAPIの仕様を記述したHTMLを出力するようにする予定ですが、HTMLファイルを用意していないので、現時点では404エラーを返すようにしましょう

```rb
def index
  head 404
end
```

この`def index`の`index`が先ほどルーティングの設定で記述した` to: characters#index`の部分になります。  
これで`/characters`にGETが来たら404が返ってくるようになりました。確認しましょう。  

![](2016/12-22-rails-api-day2-002.png)

chromeで確認してみるとちゃんと404が返ってきていますね。  
`head 404`はヘッダーで404コードを返しておいてという記述です。  
  
では次に先に全件返す`/characters/all`を書きましょう。これはコントローラーの`all`に飛ばされてきます。  
  
```rb
def all
  @characters = Character.all
  render json: @characters
end
```

`Character.all`でデータを全部取得し、それをjsonとして返却する。  
そんな感じの記述です（おそらく@はつけないほうが良い気がしている）  
これも確認してみましょう。  
  
![](2016/12-22-rails-api-day2-003.png)

どうやらちゃんと昨日追加した765プロのアイドルが全部返ってきていますね。大丈夫です。  
  
それでは最後に絞り込む`/characters/search`を作ってみましょう。  
現在の仕様としては`name`というパラメータ（必須）で名前（一部でもOKだし漢字でもふりがなでもOK）を与えるとそれに合致した物を返す。という仕様で行きましょう。  

```rb
def search
  if params[:name].blank?
    render json: [{"error": "100", "msg": "必須パラメーターがありません", "required": {"key": "name"}}]
  else 
    @result = Character.where("name like ?", "%" + params[:name] + "%")
  
    if @result.empty?
      @result = Character.where("phonetic like ?", "%" + params[:name] + "%")
    end
    
    render json: @result
  end
end
```

こんな感じにとりあえず作ってみました。  
まず最初に必須パラメータの`name`があるかチェック、ない場合はエラーなjsonを返却。  
次にデータベースの`name`にパラメータの`name`で検索し、当てはまったものを`@result`に持っておく。  
もしそれが空なら、ふりがなでも検索してみる。という形を取っています。  
  
正しく動いているか確認してみましょう。  

* <font size="5px">パラメータを渡さないときにエラーなjsonが返ってきているか</font>  
![](2016/12-22-rails-api-day2-004.png)  
大丈夫ですね、ベタ書きしたjsonが返ってきています。  

* <font size="5px">名前で検索できているか</font>  
![](2016/12-22-rails-api-day2-005.png)  
![](2016/12-22-rails-api-day2-006.png)  
試しに`天海`と`海`で検索してみました。  
`天海`では`天海春香`さんしか居ないわけですので、1件返ってきています。  
`海`では`天海春香`さんと、名前に海が入っている`双海亜美``双海真美`姉妹もいるので、合計3件返ってきています。

* <font size="5px">ふりがなで検索できているか</font>  
![](2016/12-22-rails-api-day2-007.png)  
![](2016/12-22-rails-api-day2-008.png)  
試しに`あまみ`と`まみ`で検索してみました。天海さん大人気ですね。  
`あまみ`では合致するのが`あまみはるか`さんのみなので1件返ってきています。  
`まみ`では`あまみはるか`の`まみ`と`ふたみまみ`の`まみ`で2件返ってきています。  

* <font size="5px">どれにも当てはまらないときは空で返ってきているか</font>  
![](2016/12-22-rails-api-day2-009.png)  
試しに事務員である`音無小鳥`で検索してみますと、ちゃんと空が返ってきていますね。  

これで確認が完了しました。  
絞り込むことに成功です、これで任意のアイドルの件数分だけ使う側は引っ張ってくることが出来ます。  
<br><br>
## 次は
ある程度APIの形が出来てきたので、次はテストなり、Railsについてなりここまでの悪い点の修正なりを明日やりたいと思います。  
個人で使うレベルにはさくっとAPIを作れるので大変ステキなフレームワークですね。Railsを普通に触るのは初めてですが、とても楽しいです。  
ちゃんとレスポンスが返ってくるのを自分で作って見れるのは成果がわかってモチベーションの向上にもつながりますね。  
  
以上、やぎにいでした！